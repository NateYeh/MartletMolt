# 程式碼品質審查與改善 SOP

> 本文件供 AI 助手執行程式碼品質審查與改善任務使用。

---

## 📋 任務概述

定期執行程式碼品質審查，識別問題代碼並進行改善，確保專案程式碼品質維持在良好水準。

---

## 🔧 前置準備

### 1. 確認工具已安裝

```bash
pip install radon
```

### 2. 確認專案目錄

```
/mnt/work/py_works/external_projects/MartletMolt
```

---

## 📝 執行步驟

### Step 1：執行程式碼品質審查

```bash
cd /mnt/work/py_works/external_projects/MartletMolt/tools/code_quality_review
python cli.py
```

### Step 2：閱讀審查報告

報告位於：
- **Markdown 格式**: `reports/quality_review_YYYYMMDD.md`
- **JSON 格式**: `reports/quality_review_YYYYMMDD.json`

**閱讀方式**：
```
使用 read_file 工具讀取最新的 Markdown 報告
```

### Step 3：分析問題並制定改善計畫

根據報告中的問題類型，參考以下改善策略：

#### 3.1 圈複雜度過高 (Complexity)

| 嚴重度 | 複雜度 | 改善策略 |
|--------|--------|----------|
| 🟡 中 (11-20) | C 級 | 提取方法、使用策略模式、合併條件判斷 |
| 🔴 高 (21+) | D+ 級 | **必須重構**：拆分函數、引入狀態機或責任鏈模式 |

**具體改善步驟**：
1. 識別函數中的決策點（if/elif/else, for, while, try/except）
2. 將相關邏輯提取為獨立的私有方法
3. 使用字典映射取代多重 if-elif
4. 引入策略模式處理不同分支邏輯

#### 3.2 可維護性過低 (Maintainability)

| 嚴重度 | MI 值 | 改善策略 |
|--------|-------|----------|
| 🟡 中 (10-19) | B 級 | 增加註解、簡化邏輯、提取常量 |
| 🔴 高 (<10) | C 級 | **必須重構**：模組化拆分、移除重複代碼 |

**具體改善步驟**：
1. 檢查是否有重複代碼，提取為共用函數
2. 將魔法數字提取為有意義的常量
3. 增加文件字串 (Docstring) 和關鍵註解
4. 如果檔案過大，按功能拆分為多個模組

#### 3.3 檔案過於肥大 (File Length)

| 嚴重度 | 行數 | 改善策略 |
|--------|------|----------|
| 🟡 中 (500-800) | 較大 | 考慮按功能拆分 |
| 🔴 高 (800+) | 肥大 | **必須拆分**：套用單一職責原則 |

**具體改善步驟**：
1. 分析檔案中包含哪些功能類別
2. 將不相關的類別移到獨立檔案
3. 建立明確的目錄結構：
   ```
   module/
   ├── __init__.py
   ├── service_a.py
   ├── service_b.py
   └── utils.py
   ```
4. 更新 import 路徑

### Step 4：執行改善

**重要原則**：
- 每次只改善一個問題
- 改善後立即測試
- 確保功能不受影響

**執行流程**：
1. 選擇一個問題項目
2. 讀取目標檔案
3. 分析問題代碼
4. 提出重構方案
5. **與用戶確認後再執行修改**
6. 執行修改
7. 使用 `ruff` 和 `pyright` 驗證

### Step 5：驗證改善結果

```bash
# 代碼格式檢查
ruff check <修改的檔案>

# 類型檢查
pyright <修改的檔案>

# 重新執行品質審查
cd /mnt/work/py_works/external_projects/MartletMolt/tools/code_quality_review
python cli.py
```

### Step 6：提交變更

確認改善成功後，提交變更：

```bash
git add .
git commit -m "refactor: 改善程式碼品質 - [具體改善內容]
- 降低 <file.py> 中 <function_name> 的圈複雜度從 X 到 Y
- 拆分 <file.py> 為多個模組
"
```

---

## 📊 問題優先級判斷

| 優先級 | 問題類型 | 處理順序 |
|--------|----------|----------|
| P0 | 🔴 高風險 - 圈複雜度 ≥ 21 | 立即處理 |
| P1 | 🔴 高風險 - 可維護性 C 級 | 當日處理 |
| P2 | 🔴 高風險 - 檔案行數 > 800 | 當週處理 |
| P3 | 🟡 中風險 - 圈複雜度 11-20 | 規劃處理 |
| P4 | 🟡 中風險 - 可維護性 B 級 | 視情況處理 |
| P5 | 🟡 中風險 - 檔案行數 500-800 | 視情況處理 |

---

## ⚠️ 注意事項

1. **修改前必須確認**
   - 提出改善方案後，必須等待用戶確認「開始實作」
   - 不得在未確認的情況下執行修改

2. **保持功能不變**
   - 重構的目的是改善結構，不改變行為
   - 修改後應確保測試通過

3. **漸進式改善**
   - 每次改善一個問題
   - 避免大規模重構導致難以追蹤問題

4. **保留 Git 歷史**
   - 重構時盡量保持 commit 可追溯
   - 大型重構建議分多次 commit

---

## 🔄 週期性執行建議

| 執行時機 | 說明 |
|----------|------|
| 每週 | 執行一次完整審查，處理 P0/P1 問題 |
| 每次發版前 | 確保無高風險問題 |
| 大功能開發後 | 檢查新增代碼的品質 |

---

## 📎 相關檔案

- 審查工具: `tools/code_quality_review/cli.py`
- 核心邏輯: `tools/code_quality_review/reviewer.py`
- 報告目錄: `tools/code_quality_review/reports/`
- 使用說明: `tools/code_quality_review/README.md`

---

## 💡 範例執行對話

```
AI: 我開始執行程式碼品質審查...

[執行 cli.py]

AI: 審查完成，發現以下問題：

🔴 高風險問題：
1. system_b/martlet_molt/cli.py - _chat_interactive() 複雜度 25

建議改善方案：
- 將互動邏輯拆分為 _process_user_input(), _handle_tool_call() 等子函數
- 使用命令模式處理不同用戶指令

是否開始實作？

User: 開始實作

AI: [執行重構...]
```

---

**文件版本**: 1.0.0  
**最後更新**: 2024