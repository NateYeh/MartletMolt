{% extends "base.html" %}

{% block title %}èŠå¤© - MartletMolt{% endblock %}

{% block content %}
<!-- é ‚éƒ¨å°èˆªæ¬„ -->
<header class="h-16 border-b border-gray-200 dark:border-slate-700 flex items-center px-6 bg-white dark:bg-slate-900 flex-shrink-0">
    <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-4">
            <h1 class="text-lg font-semibold text-gray-900 dark:text-gray-100" 
                x-text="sessionMetadata.title || (messages.length > 0 ? 'å°è©±è©³æƒ…' : 'æ–°å°è©±')"></h1>
            <span class="px-3 py-1 text-xs font-medium bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full"
                  x-text="'ID: ' + sessionId">
            </span>
            <!-- WebSocket é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
            <span x-data
                  :class="$store.ws?.connected ? 'bg-green-100 dark:bg-green-900/20 text-green-600 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400'"
                  class="px-2 py-1 text-xs font-medium rounded-full transition-colors">
                <span x-show="$store.ws?.connected" class="flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                    å·²é€£ç·š
                </span>
                <span x-show="!$store.ws?.connected" class="flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                    æœªé€£ç·š
                </span>
            </span>
        </div>
        
        <div class="flex items-center space-x-2">
            <!-- æ¸…ç©ºå°è©±æŒ‰éˆ• -->
            <button @click="clearMessages()" 
                    x-show="messages.length > 0"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors"
                    title="æ¸…ç©ºå°è©±">
                <svg class="w-5 h-5 text-gray-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </button>
        </div>
    </div>
</header>

<!-- èŠå¤©ä¸»å€åŸŸ -->
<div class="flex-1 flex flex-col overflow-hidden" x-data="chatApp()" x-init="init()">
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <div id="chat-messages" 
         x-ref="messagesContainer"
         class="flex-1 overflow-y-auto px-6 py-6 scroll-smooth">
        
        <!-- ç©ºç‹€æ…‹ - æ­¡è¿è¨Šæ¯ -->
        <div x-show="messages.length === 0 && !isLoading" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="h-full flex flex-col items-center justify-center max-w-3xl mx-auto w-full fade-in">
            
            <!-- Logo å‹•ç•« -->
            <div class="text-7xl mb-6 animate-bounce-slow">ğŸ¦…</div>
            
            <!-- æ¨™é¡Œ -->
            <h2 class="text-3xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                æ­¡è¿ä½¿ç”¨ MartletMolt
            </h2>
            
            <p class="text-gray-500 dark:text-slate-400 text-lg mb-8 text-center">
                è‡ªæˆ‘é€²åŒ–çš„ AI Agent ç³»çµ±<br>
                <span class="text-sm">é–‹å§‹å°è©±ï¼Œè¦‹è­‰ AI è‡ªæˆ‘ä¿®æ”¹çš„åŠ›é‡</span>
            </p>
            
            <!-- å¿«æ·å»ºè­°æŒ‰éˆ• -->
            <div class="grid grid-cols-2 gap-3 w-full max-w-2xl">
                <template x-for="(suggestion, index) in suggestions" :key="index">
                    <button @click="sendSuggestion(suggestion.text)"
                            class="group px-4 py-4 bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-500 hover:shadow-lg transition-all duration-200 text-left">
                        <div class="text-2xl mb-2" x-text="suggestion.icon"></div>
                        <div class="text-sm font-medium text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400" x-text="suggestion.text"></div>
                    </button>
                </template>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div x-show="messages.length > 0" class="max-w-3xl mx-auto w-full space-y-6">
            <template x-for="(message, index) in messages" :key="index">
                <div class="flex flex-col gap-2">
                    <!-- ç³»çµ±è¨Šæ¯æ¨£å¼ (å…¨å¯¬å±…ä¸­) -->
                    <template x-if="message.role === 'system'">
                        <div class="flex justify-center my-4">
                            <div class="bg-gray-100 dark:bg-slate-800/50 rounded-lg px-4 py-2 border border-gray-200 dark:border-slate-700 max-w-[90%] text-center">
                                <div class="flex items-center justify-center space-x-2 mb-1">
                                    <span class="text-[10px] font-bold tracking-wider text-gray-400 uppercase">System Prompt</span>
                                </div>
                                <div class="text-xs text-gray-500 dark:text-slate-400 italic break-words line-clamp-3 hover:line-clamp-none transition-all cursor-help" 
                                     x-text="message.content"></div>
                            </div>
                        </div>
                    </template>

                    <!-- æ¨™æº–å°è©±æ¨£å¼ (User/Assistant/Tool) -->
                    <template x-if="message.role !== 'system'">
                        <div class="flex gap-3 fade-in" 
                             :class="message.role === 'user' ? 'justify-end' : 'justify-start'"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform translate-y-2"
                             x-transition:enter-end="opacity-100 transform translate-y-0">
                            
                            <!-- Avatar (Assistant & Tool) -->
                            <div x-show="message.role === 'assistant' || message.role === 'tool'" class="flex-shrink-0">
                                <div class="w-9 h-9 rounded-full flex items-center justify-center text-white text-lg shadow-sm"
                                     :class="message.role === 'assistant' ? 'bg-gradient-to-br from-blue-500 to-purple-600' : 'bg-amber-500'">
                                    <span x-text="message.role === 'assistant' ? 'ğŸ¦…' : 'ğŸ› ï¸'"></span>
                                </div>
                            </div>
                            
                            <!-- æ¶ˆæ¯å…§å®¹ -->
                            <div class="flex-1 max-w-[85%]" :class="message.role === 'user' ? 'order-1' : ''">
                                <!-- è§’è‰²æ¨™ç±¤ -->
                                <div class="flex items-center mb-1" :class="message.role === 'user' ? 'justify-end' : 'justify-start'">
                                    <span class="text-xs font-medium text-gray-500 dark:text-slate-400" 
                                          x-text="message.role === 'user' ? 'ä½ ' : (message.role === 'assistant' ? 'MartletMolt' : 'å·¥å…·åŸ·è¡Œ: ' + (message.name || 'Unknown'))"></span>
                                    <template x-if="message.role === 'assistant'">
                                        <span class="ml-2 px-2 py-0.5 text-[10px] bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full font-bold">AI</span>
                                    </template>
                                    <template x-if="message.role === 'tool'">
                                        <span class="ml-2 px-2 py-0.5 text-[10px] bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-full font-bold">RESULT</span>
                                    </template>
                                </div>
                                
                                <!-- Tool Calls (If any in assistant message) -->
                                <template x-if="message.role === 'assistant' && message.tool_calls && message.tool_calls.length > 0">
                                    <div class="mb-2 space-y-1">
                                        <template x-for="call in message.tool_calls" :key="call.id">
                                            <div class="text-[11px] bg-slate-100 dark:bg-slate-700/50 rounded px-2 py-1 text-slate-500 flex items-center border border-slate-200 dark:border-slate-600">
                                                <span class="mr-2">âš¡ å‘¼å«å·¥å…·: <strong x-text="call.function?.name || call.name"></strong></span>
                                                <span class="opacity-60 overflow-hidden text-ellipsis whitespace-nowrap" x-text="call.function?.arguments || JSON.stringify(call.arguments)"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- æ¶ˆæ¯æ¡† -->
                                <div class="rounded-2xl px-4 py-3 shadow-sm"
                                     :class="{
                                        'bg-blue-600 text-white rounded-tr-sm': message.role === 'user',
                                        'bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-tl-sm': message.role === 'assistant',
                                        'bg-amber-50/50 dark:bg-amber-900/10 border border-amber-200 dark:border-amber-800/50 rounded-tl-sm': message.role === 'tool'
                                     }">
                                    
                                    <!-- æ€è€ƒéç¨‹/Reasoning (å¦‚æœæœ‰ content ä¸”ä»¥ <thought> é–‹é ­æˆ–åŒ…å«æ€è€ƒé‚è¼¯) -->
                                    <template x-if="message.role === 'assistant' && message.content && message.content.includes('<thought>')">
                                        <div class="mb-3 border-l-2 border-slate-300 dark:border-slate-600 pl-3 py-1 text-sm text-slate-500 dark:text-slate-400 bg-slate-50/50 dark:bg-slate-900/30 rounded-r">
                                            <details>
                                                <summary class="cursor-pointer font-medium hover:text-blue-500 transition-colors">æ€è€ƒéç¨‹</summary>
                                                <div class="mt-2 text-xs leading-relaxed" x-text="message.content.match(/<thought>([\s\S]*?)<\/thought>/)?.[1] || 'è§£æä¸­...'"></div>
                                            </details>
                                        </div>
                                    </template>

                                    <!-- å¯¦éš›å›è¦†å…§å®¹ (ç§»é™¤ thought æ¨™ç±¤å¾Œé¡¯ç¤º) -->
                                    <div class="markdown-body"
                                         :class="{
                                            'text-white': message.role === 'user',
                                            'text-gray-900 dark:text-gray-100': message.role !== 'user',
                                            'text-xs font-mono opacity-80': message.role === 'tool'
                                         }"
                                         x-html="renderMarkdown(message.role === 'assistant' ? message.content.replace(/<thought>[\s\S]*?<\/thought>/, '') : message.content)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User Avatar -->
                            <div x-show="message.role === 'user'" class="flex-shrink-0 order-2">
                                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white text-lg shadow-sm">
                                    ğŸ‘¤
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
            
            <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
            <div x-show="isLoading" 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 class="flex gap-3 fade-in">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-lg shadow-sm flex-shrink-0">
                    ğŸ¦…
                </div>
                <div class="flex-1 max-w-[85%]">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl rounded-tl-sm px-4 py-3 border border-gray-200 dark:border-slate-700 shadow-sm">
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                                <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0.15s"></div>
                                <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
                            </div>
                            <span class="text-sm text-gray-500 dark:text-slate-400">æ€è€ƒä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¼¸å…¥å€åŸŸ -->
    <div class="border-t border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-6 flex-shrink-0">
        <form @submit.prevent="sendMessage()" class="max-w-3xl mx-auto">
            <!-- è¼¸å…¥æ¡†å®¹å™¨ -->
            <div class="relative bg-white dark:bg-slate-800 rounded-2xl border border-gray-300 dark:border-slate-600 shadow-lg hover:shadow-xl transition-shadow duration-200 focus-within:border-blue-500 dark:focus-within:border-blue-500">
                <!-- Textarea -->
                <textarea x-model="inputMessage"
                          @keydown.enter="if (!event.shiftKey) { event.preventDefault(); sendMessage(); }"
                          @input="autoResize($event)"
                          placeholder="è¼¸å…¥è¨Šæ¯... (Shift+Enter æ›è¡Œ)"
                          rows="1"
                          class="w-full bg-transparent px-4 py-4 pr-32 resize-none focus:outline-none text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-slate-500"
                          :disabled="isLoading"
                          style="max-height: 200px;">
                </textarea>
                
                <!-- å·¥å…·åˆ— -->
                <div class="absolute bottom-3 right-3 flex items-center space-x-2">
                    <!-- é™„åŠ åŠŸèƒ½æŒ‰éˆ• -->
                    <input type="file" x-ref="fileInput" class="hidden" @change="uploadFile($event)">
                    <button type="button" 
                            @click="$refs.fileInput.click()"
                            :disabled="isUploading"
                            class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors group relative"
                            title="ä¸Šå‚³æ–‡ä»¶">
                        <svg class="w-5 h-5 text-gray-400 dark:text-slate-500 group-hover:text-gray-600 dark:group-hover:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                        <!-- ä¸Šå‚³ä¸­å‹•ç•« -->
                        <span x-show="isUploading" class="absolute inset-0 flex items-center justify-center bg-white/50 dark:bg-slate-800/50 rounded-lg">
                            <svg class="animate-spin h-4 w-4 text-blue-600" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- ç™¼é€æŒ‰éˆ• -->
                    <button type="submit"
                            :disabled="!inputMessage.trim() || isLoading"
                            class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 dark:disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-all duration-200 flex items-center space-x-2 active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        <span>ç™¼é€</span>
                    </button>
                </div>
            </div>
            
            <!-- åº•éƒ¨æç¤º -->
            <p class="text-xs text-gray-400 dark:text-slate-500 text-center mt-3">
                MartletMolt å¯èƒ½æœƒç”¢ç”Ÿä¸æº–ç¢ºçš„è³‡è¨Šï¼Œè«‹é©—è­‰é‡è¦å…§å®¹ã€‚
            </p>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Alpine.js WebSocket ç‹€æ…‹ Store -->
<script>
document.addEventListener('alpine:init', () => {
    Alpine.store('ws', {
        connected: false,
        setConnected(value) {
            this.connected = value;
        }
    });
});
</script>

<script>
function chatApp() {
    return {
        messages: [],
        inputMessage: '',
        isLoading: false,
        isUploading: false,
        sessionId: 'default',
        sessionMetadata: {},
        backendUrl: '{{ backend_url }}',
        websocket: null,
        
        suggestions: [
            { icon: 'ğŸ¤–', text: 'ä»€éº¼æ˜¯è‡ªæˆ‘é€²åŒ– AIï¼Ÿ' },
            { icon: 'ğŸ—ï¸', text: 'åˆ†æ MartletMolt çš„æ¶æ§‹' },
            { icon: 'ğŸ”§', text: 'ä»‹ç´¹å·¥å…·ç³»çµ±çš„åŠŸèƒ½' },
            { icon: 'ğŸš€', text: 'å¦‚ä½•è§¸ç™¼é€²åŒ–æµç¨‹ï¼Ÿ' },
        ],
        
        init() {
            console.log('[ChatApp] åˆå§‹åŒ–å®Œæˆ');
            this.loadSessionId();
            this.adjustBackendUrl();
            this.fetchHistory().then(() => {
                this.connectWebSocket();
            });
        },

        async fetchHistory() {
            try {
                const url = `${this.backendUrl}/sessions/${this.sessionId}`;
                console.log('[ChatApp] æ­£åœ¨æŠ“å–æ­·å²ç´€éŒ„:', url);
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    this.messages = data.messages || [];
                    this.sessionMetadata = data.metadata || {};
                    console.log(`[ChatApp] è¼‰å…¥ ${this.messages.length} æ¢åŸå§‹è¨Šæ¯ï¼Œæ¨™é¡Œ: ${this.sessionMetadata.title || 'ç„¡'}`);
                    this.scrollToBottom();
                }
            } catch (error) {
                console.error('[ChatApp] æŠ“å–æ­·å²å¤±æ•—:', error);
            }
        },

        adjustBackendUrl() {
            // è‡ªå‹•åµæ¸¬ç•¶å‰ç’°å¢ƒï¼Œå¦‚æœæ˜¯é ç«¯å­˜å–ï¼Œå‰‡åŒæ­¥ä¿®æ­£å¾Œç«¯ API åœ°å€
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            
            // æƒ…æ³ A: å‰ç«¯èˆ‡ Orchestrator éƒ½åœ¨åŒä¸€å€‹ IP è¿è¡Œ (æœ€å¸¸è¦‹)
            if (currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
                if (this.backendUrl.includes('localhost') || this.backendUrl.includes('127.0.0.1')) {
                    const originalUrl = new URL(this.backendUrl);
                    // ä¿æŒåŸæœ¬é…ç½®çš„ Portï¼Œé™¤éåŸæœ¬å°±æ˜¯ 8002 (å‰ç«¯ Port)ï¼Œå‰‡å˜—è©¦æ›æˆ 8000
                    const targetPort = originalUrl.port;
                    this.backendUrl = `${window.location.protocol}//${currentHost}:${targetPort}`;
                    console.log('[ChatApp] åµæ¸¬åˆ°é ç«¯å­˜å–ï¼Œè‡ªå‹•ä¿®æ­£ API URL:', this.backendUrl);
                }
            }
        },

        async uploadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            this.isUploading = true;
            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('[ChatApp] ä¸Šå‚³æ–‡ä»¶ä¸­:', file.name);
                const response = await fetch(`${this.backendUrl}/files/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    // åœ¨å°è©±ä¸­åŠ å…¥ä¸Šå‚³æˆåŠŸçš„é€šçŸ¥
                    this.messages.push({
                        role: 'system',
                        content: `âœ… æ–‡ä»¶ä¸Šå‚³æˆåŠŸ: ${file.name} (${(data.size / 1024).toFixed(1)} KB)`
                    });
                    this.scrollToBottom();
                } else {
                    alert('æ–‡ä»¶ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                console.error('[ChatApp] ä¸Šå‚³éŒ¯èª¤:', error);
                alert('ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            } finally {
                this.isUploading = false;
                event.target.value = ''; // æ¸…ç©º input
            }
        },
        
        loadSessionId() {
            // å¾ URL åƒæ•¸æˆ– localStorage è¼‰å…¥ session_id
            const urlParams = new URLSearchParams(window.location.search);
            this.sessionId = urlParams.get('session') || localStorage.getItem('sessionId') || 'default';
        },

        getWebSocketUrl() {
            // å°‡ HTTP URL è½‰æ›ç‚º WebSocket URL
            const url = new URL(this.backendUrl);
            const protocol = url.protocol === 'https:' ? 'wss:' : 'ws:';
            return `${protocol}//${url.host}/ws/${this.sessionId}`;
        },

        connectWebSocket() {
            const wsUrl = this.getWebSocketUrl();
            console.log('[ChatApp] é€£ç·šè‡³ WebSocket:', wsUrl);

            try {
                this.websocket = new WebSocket(wsUrl);

                this.websocket.onopen = () => {
                    console.log('[ChatApp] WebSocket å·²é€£ç·š');
                    Alpine.store('ws').setConnected(true);
                };

                this.websocket.onclose = (event) => {
                    console.log('[ChatApp] WebSocket å·²æ–·é–‹:', event.code, event.reason);
                    Alpine.store('ws').setConnected(false);
                    
                    // å˜—è©¦é‡é€£ï¼ˆå»¶é² 3 ç§’ï¼‰
                    setTimeout(() => {
                        if (!Alpine.store('ws').connected) {
                            console.log('[ChatApp] å˜—è©¦é‡æ–°é€£ç·š...');
                            this.connectWebSocket();
                        }
                    }, 3000);
                };

                this.websocket.onerror = (error) => {
                    console.error('[ChatApp] WebSocket éŒ¯èª¤è©³æƒ…:', {
                        url: wsUrl,
                        readyState: this.websocket.readyState,
                        error: error
                    });
                    Alpine.store('ws').setConnected(false);
                };

                this.websocket.onmessage = (event) => {
                    this.handleWebSocketMessage(event.data);
                };

            } catch (error) {
                console.error('[ChatApp] å»ºç«‹ WebSocket å¤±æ•—:', error);
                Alpine.store('ws').setConnected(false);
            }
        },

        handleWebSocketMessage(data) {
            try {
                const response = JSON.parse(data);
                const { content, success, error, metadata } = response;
                const type = metadata?.type || 'stream';

                if (type === 'stream' && content) {
                    // ä¸²æµç‰‡æ®µï¼šé™„åŠ åˆ°æœ€å¾Œä¸€æ¢ assistant è¨Šæ¯
                    const lastMessage = this.messages[this.messages.length - 1];
                    if (lastMessage && lastMessage.role === 'assistant') {
                        lastMessage.content += content;
                    }
                    this.scrollToBottom();
                } 
                else if (type === 'done') {
                    // ä¸²æµå®Œæˆ
                    console.log('[ChatApp] ä¸²æµå®Œæˆï¼Œé‡æ–°åŒæ­¥æœ€å¾Œä¸€æ¢è¨Šæ¯');
                    this.fetchHistory().then(() => {
                        this.isLoading = false;
                        this.scrollToBottom();
                        // é€šçŸ¥å´é‚Šæ¬„æ›´æ–°åˆ—è¡¨
                        window.dispatchEvent(new CustomEvent('session-updated'));
                    });
                } 
                else if (type === 'error') {
                    // éŒ¯èª¤
                    console.error('[ChatApp] ä¼ºæœå™¨éŒ¯èª¤:', error);
                    const lastMessage = this.messages[this.messages.length - 1];
                    if (lastMessage && lastMessage.role === 'assistant') {
                        lastMessage.content = `æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š${error}`;
                    }
                    this.isLoading = false;
                }

            } catch (e) {
                console.error('[ChatApp] è§£æè¨Šæ¯å¤±æ•—:', e);
            }
        },
        
        async sendMessage() {
            const message = this.inputMessage.trim();
            if (!message || this.isLoading) return;

            // æª¢æŸ¥ WebSocket é€£ç·šç‹€æ…‹
            if (!Alpine.store('ws').connected || this.websocket?.readyState !== WebSocket.OPEN) {
                console.warn('[ChatApp] WebSocket æœªé€£ç·šï¼Œå˜—è©¦é‡é€£...');
                this.connectWebSocket();
                
                // ç­‰å¾…é€£ç·š
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (!Alpine.store('ws').connected) {
                    this.messages.push({ 
                        role: 'assistant', 
                        content: 'æŠ±æ­‰ï¼Œç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' 
                    });
                    return;
                }
            }
            
            // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
            this.messages.push({ role: 'user', content: message });
            this.inputMessage = '';
            this.isLoading = true;
            
            // é‡ç½® textarea é«˜åº¦
            const textarea = document.querySelector('textarea');
            if (textarea) textarea.style.height = 'auto';
            
            // å…ˆæ·»åŠ ä¸€å€‹ç©ºçš„åŠ©ç†æ¶ˆæ¯ï¼Œç”¨æ–¼ä¸²æµé¡¯ç¤º
            this.messages.push({ role: 'assistant', content: '' });
            this.scrollToBottom();
            
            try {
                // é€é WebSocket ç™¼é€è¨Šæ¯
                const payload = {
                    content: message,
                    user_id: 'web_user'
                };
                
                this.websocket.send(JSON.stringify(payload));
                console.log('[ChatApp] å·²ç™¼é€è¨Šæ¯');
                
            } catch (error) {
                console.error('[ChatApp] ç™¼é€è¨Šæ¯å¤±æ•—:', error);
                const lastMessage = this.messages[this.messages.length - 1];
                if (lastMessage && lastMessage.role === 'assistant') {
                    lastMessage.content = `æŠ±æ­‰ï¼Œç™¼é€è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
                }
                this.isLoading = false;
            }
        },
        
        sendSuggestion(suggestion) {
            this.inputMessage = suggestion;
            this.sendMessage();
        },
        
        clearMessages() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
                this.messages = [];
                this.sessionId = 'default';
            }
        },
        
        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$refs.messagesContainer;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },
        
        autoResize(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        },
        
        renderMarkdown(content) {
            if (!content) return '';
            
            try {
                // ä½¿ç”¨ marked è§£æ Markdown
                const html = marked.parse(content);
                return html;
            } catch (error) {
                console.error('[ChatApp] Markdown è§£æéŒ¯èª¤:', error);
                return content;
            }
        }
    }
}
</script>

<!-- éš±è—å…ƒç´ æ¨£å¼ (é¿å… Alpine.js é–ƒçˆ) -->
<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}