# JavaScript/TypeScript SDK

language: TypeScript
filename: MartletMoltClient.ts
version: "0.1.0"

description: |
  MartletMolt 後端 API 客戶端 SDK，提供完整的 TypeScript 類型定義和使用範例。

sections:
  - name: 類型定義
    code: |
      // ============================================
      // 類型定義
      // ============================================

      export interface HealthResponse {
        status: string;
        system: string;
        version: string;
      }

      export interface StatusResponse {
        system: string;
        active: boolean;
        tools: string[];
        provider: string;
        model: string;
      }

      export interface ChatRequest {
        message: string;
        session_id?: string;
        stream?: boolean;
      }

      export interface ChatResponse {
        message: string;
        session_id: string;
      }

      export interface SessionInfo {
        id: string;
        created_at: string;
        updated_at: string;
        message_count: number;
        tool_call_count: number;
        metadata: Record<string, any>;
      }

      export interface SessionListResponse {
        sessions: SessionInfo[];
        total: number;
      }

      export interface Message {
        id: string;
        role: string;
        content: string;
        name?: string | null;
        tool_call_id?: string | null;
        tool_calls?: any[] | null;
        timestamp: string;
      }

      export interface SessionDetailResponse {
        id: string;
        created_at: string;
        updated_at: string;
        messages: Message[];
        tool_calls: any[];
        metadata: Record<string, any>;
      }

      export interface DeleteSessionResponse {
        success: boolean;
        message: string;
      }

      export interface ApiError {
        detail: string;
      }

  - name: SDK 類別
    code: |
      // ============================================
      // SDK 類別
      // ============================================

      export class MartletMoltClient {
        private baseUrl: string;
        private timeout: number;

        /**
         * 建立客戶端實例
         * 
         * @param baseUrl - API 基礎 URL（預設: http://localhost:8001）
         * @param timeout - 請求超時時間（毫秒，預設: 30000）
         */
        constructor(baseUrl: string = 'http://localhost:8001', timeout: number = 30000) {
          this.baseUrl = baseUrl.replace(/\/$/, ''); // 移除結尾斜線
          this.timeout = timeout;
        }

        /**
         * 健康檢查
         * 
         * @returns 健康狀態
         */
        async health(): Promise<HealthResponse> {
          const response = await this.request('GET', '/health');
          return response.json();
        }

        /**
         * 取得系統狀態
         * 
         * @returns 系統狀態資訊
         */
        async status(): Promise<StatusResponse> {
          const response = await this.request('GET', '/status');
          return response.json();
        }

        /**
         * 同步對話
         * 
         * @param message - 用戶訊息
         * @param sessionId - 會話 ID（可選）
         * @returns AI 回應
         */
        async chat(message: string, sessionId?: string): Promise<ChatResponse> {
          const body: ChatRequest = { message };
          if (sessionId) body.session_id = sessionId;

          const response = await this.request('POST', '/chat', body);
          return response.json();
        }

        /**
         * 串流對話
         * 
         * @param message - 用戶訊息
         * @param sessionId - 會話 ID（可選）
         * @param onChunk - 接收數據塊的回調函數
         * @param onError - 錯誤處理回調函數（可選）
         */
        async chatStream(
          message: string,
          sessionId: string | undefined,
          onChunk: (chunk: string) => void,
          onError?: (error: string) => void
        ): Promise<void> {
          const body: ChatRequest = { message };
          if (sessionId) body.session_id = sessionId;

          const response = await this.request('POST', '/chat/stream', body);
          const reader = response.body?.getReader();
          const decoder = new TextDecoder();

          if (!reader) {
            throw new Error('無法讀取串流數據');
          }

          try {
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split('\n');

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.substring(6).trim();
                  
                  if (data === '[DONE]') {
                    return;
                  } else if (data.startsWith('[ERROR]')) {
                    const errorMsg = data.substring(8);
                    if (onError) {
                      onError(errorMsg);
                    } else {
                      throw new Error(errorMsg);
                    }
                  } else if (data) {
                    onChunk(data);
                  }
                }
              }
            }
          } finally {
            reader.releaseLock();
          }
        }

        /**
         * 列出所有會話
         * 
         * @returns 會話列表
         */
        async listSessions(): Promise<SessionListResponse> {
          const response = await this.request('GET', '/sessions');
          return response.json();
        }

        /**
         * 取得會話詳情
         * 
         * @param sessionId - 會話 ID
         * @returns 會話詳細資訊
         */
        async getSession(sessionId: string): Promise<SessionDetailResponse> {
          const response = await this.request('GET', `/sessions/${sessionId}`);
          return response.json();
        }

        /**
         * 刪除會話
         * 
         * @param sessionId - 會話 ID
         * @returns 刪除結果
         */
        async deleteSession(sessionId: string): Promise<DeleteSessionResponse> {
          const response = await this.request('DELETE', `/sessions/${sessionId}`);
          return response.json();
        }

        /**
         * 發送 HTTP 請求
         * 
         * @private
         */
        private async request(
          method: string,
          path: string,
          body?: any
        ): Promise<Response> {
          const url = `${this.baseUrl}${path}`;
          const options: RequestInit = {
            method,
            headers: {
              'Content-Type': 'application/json',
            },
          };

          if (body) {
            options.body = JSON.stringify(body);
          }

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), this.timeout);
          options.signal = controller.signal;

          try {
            const response = await fetch(url, options);
            
            if (!response.ok) {
              const error: ApiError = await response.json();
              throw new Error(`HTTP ${response.status}: ${error.detail}`);
            }

            return response;
          } catch (error: any) {
            if (error.name === 'AbortError') {
              throw new Error('請求超時');
            }
            throw error;
          } finally {
            clearTimeout(timeoutId);
          }
        }
      }

usage_examples:
  - name: 基本對話
    code: |
      async function exampleBasicChat() {
        const client = new MartletMoltClient();
        
        const response = await client.chat('你好，請介紹一下你自己');
        console.log('AI 回應:', response.message);
        console.log('會話 ID:', response.session_id);
      }

  - name: 串流對話
    code: |
      async function exampleStreamChat() {
        const client = new MartletMoltClient();
        
        console.log('AI: ');
        await client.chatStream(
          '寫一個 Python 快速排序算法',
          'coding-session',
          (chunk) => {
            process.stdout.write(chunk); // 即時輸出
          },
          (error) => {
            console.error('錯誤:', error);
          }
        );
        console.log('\n');
      }

  - name: 持續對話（使用 session_id）
    code: |
      async function exampleContinuousChat() {
        const client = new MartletMoltClient();
        const sessionId = 'my-conversation-123';

        // 第一次對話
        const response1 = await client.chat('我叫小明', sessionId);
        console.log('AI:', response1.message);

        // 第二次對話（會記住上下文）
        const response2 = await client.chat('我叫什麼名字？', sessionId);
        console.log('AI:', response2.message); // 應該會回答「小明」
      }

  - name: 檢查系統狀態
    code: |
      async function exampleCheckStatus() {
        const client = new MartletMoltClient();
        
        const health = await client.health();
        console.log('服務狀態:', health.status);
        console.log('系統:', health.system);

        const status = await client.status();
        console.log('可用的工具:', status.tools);
        console.log('當前模型:', status.model);
      }

  - name: 會話管理
    code: |
      async function exampleSessionManagement() {
        const client = new MartletMoltClient();

        // 列出所有會話
        const sessions = await client.listSessions();
        console.log('總會話數:', sessions.total);
        sessions.sessions.forEach(session => {
          console.log(`- ${session.id}: ${session.message_count} 條訊息`);
        });

        // 取得特定會話詳情
        const sessionDetail = await client.getSession('my-session');
        console.log('會話 ID:', sessionDetail.id);
        sessionDetail.messages.forEach(msg => {
          console.log(`[${msg.role}] ${msg.content}`);
        });

        // 刪除會話
        const result = await client.deleteSession('old-session');
        console.log(result.message);
      }