# MartletMolt 雙容器架構設計書

> **文檔版本**: v1.0  
> **建立日期**: 2025-01-21  
> **狀態**: 規劃中 (Planning)

---

## 📋 目錄

1. [架構概述](#1-架構概述)
2. [設計目標](#2-設計目標)
3. [容器職責劃分](#3-容器職責劃分)
4. [技術架構圖](#4-技術架構圖)
5. [實作計畫表](#5-實作計畫表)
6. [安全性設計](#6-安全性設計)
7. [風險評估](#7-風險評估)
8. [未來擴展](#8-未來擴展)

---

## 1. 架構概述

### 1.1 核心概念

MartletMolt 採用 **雙容器架構**，將 AI Agent 運行環境與安全性代理服務分離：

```
┌─────────────────────────────────────────────────────────────┐
│                     Docker Environment                       │
│                                                              │
│  ┌─────────────────────┐       ┌─────────────────────────┐  │
│  │   Main Container    │       │   Proxy Container       │  │
│  │   (AI Agent Core)   │◄─────►│   (Gateway & Config)    │  │
│  │                     │  內部  │                         │  │
│  │  - Agent Logic      │  網路  │  - API Key 管理         │  │
│  │  - Skills System    │       │  - 請求轉發             │  │
│  │  - Memory/Context   │       │  - 審計日誌             │  │
│  │                     │       │  - 配置管理             │  │
│  └─────────────────────┘       └───────────┬─────────────┘  │
│                                            │                │
└────────────────────────────────────────────┼────────────────┘
                                             │
                                    ┌────────▼────────┐
                                    │   External APIs │
                                    │  (OpenAI, etc.) │
                                    └─────────────────┘
```

### 1.2 關鍵特性

| 特性 | 說明 |
|------|------|
| 🔐 **密鑰隔離** | 真實 API Key 永不暴露給主容器 |
| 🔄 **代理轉發** | 所有外部 API 調用經過副容器代理 |
| 📊 **統一審計** | 集中記錄所有 API 調用與計費 |
| ⚡ **高可用** | 支援故障降級與熱重載 |
| 🎯 **職責分離** | 主容器專注邏輯，副容器處理安全 |

---

## 2. 設計目標

### 2.1 安全性目標

- [ ] **零信任架構**: 主容器不持有任何真實憑證
- [ ] **最小權限原則**: 容器間通訊採用最小必要權限
- [ ] **密鑰輪換**: 支援無縫更換 API Key 而不重啟服務
- [ ] **審計追蹤**: 完整記錄所有 API 調用與異常行為

### 2.2 可靠性目標

- [ ] **99.9% 可用性**: 副容器高可用設計
- [ ] **故障降級**: 代理故障時的應急策略
- [ ] **自動恢復**: 容器異常自動重啟
- [ ] **健康檢查**: 實時監控容器狀態

### 2.3 擴展性目標

- [ ] **多供應商支援**: OpenAI, Anthropic, Gemini, Azure OpenAI
- [ ] **水平擴展**: 支援多個主容器實例
- [ ] **負載均衡**: 副容器支援負載分擔
- [ ] **插件化架構**: 易於添加新的 AI 服務商

---

## 3. 容器職責劃分

### 3.1 主容器 (Main Container - Agent Core)

#### 主要職責

```
┌────────────────────────────────────────────────────────┐
│                   主容器 (Agent Core)                   │
├────────────────────────────────────────────────────────┤
│ 模組              │ 功能描述                            │
├──────────────────┼─────────────────────────────────────┤
│ Agent Engine     │ 推理引擎、決策邏輯                   │
│ Skills System    │ 技能註技能註冊、執行、管理                 │
│ Memory System    │ 對話記憶、上下文管理                 │
│ Tool Manager     │ 工具調用、結果處理                   │
│ API Client       │ 統一 API 調用介面 (使用代理 Key)     │
└────────────────────────────────────────────────────────┘
```

#### 持有的憑證

- ✅ 代理 API Key (由副容器生成)
- ❌ 真實 API Key (永不存在)
- ✅ 容器間通訊 Token

### 3.2 副容器 (Proxy Container - Gateway)

#### 主要職責

```
┌────────────────────────────────────────────────────────┐
│                   副容器 (Gateway)                      │
├────────────────────────────────────────────────────────┤
│ 模組              │ 功能描述                            │
├──────────────────┼─────────────────────────────────────┤
│ Key Manager      │ 真實 Key 安全存儲、輪換             │
│ Proxy Server     │ API 請求轉發、響應緩存              │
│ Key Generator    │ 代理 Key 生成、驗證                 │
│ Audit Logger     │ 完整調用日誌、計費統計              │
│ Config Manager   │ 配置熱更新、環境變量管理            │
│ Rate Limiter     │ 請求頻率控制、配額管理              │
└────────────────────────────────────────────────────────┘
```

#### 持有的憑證

- ✅ 真實 API Key (所有 AI 服務商)
- ✅ 代理 Key 映射表
- ✅ 加密金鑰 (容器間通訊)
- ✅ 管理員 Token

---

## 4. 技術架構圖

### 4.1 通訊流程圖

```
┌──────────────────────────────────────────────────────────────────┐
│                        API 調用流程                               │
└──────────────────────────────────────────────────────────────────┘

Main Container                         Proxy Container              External API
     │                                       │                           │
     │  1. POST /v1/chat/completions         │                           │
     │  Headers: X-Proxy-Key: agent_xxx      │                           │
     │  Body: {messages, model, ...}         │                           │
     │──────────────────────────────────────►│                           │
     │                                       │                           │
     │                    2. 驗證 Proxy Key  │                           │
     │                       查詢對應真實Key │                           │
     │                                       │                           │
     │                    3. 記錄審計日誌    │                           │
     │                                       │                           │
     │                                       │  4. POST /v1/chat/completions
     │                                       │  Headers: Authorization: Bearer sk-real-xxx
     │                                       │  Body: {messages, model, ...}
     │                                       │──────────────────────────►│
     │                                       │                           │
     │                                       │  5. Response {choices, usage, ...}
     │                                       │◄──────────────────────────│
     │                                       │                           │
     │                    6. 記錄用量統計    │                           │
     │                                       │                           │
     │  7. Response {choices, usage, ...}    │                           │
     │◄──────────────────────────────────────│                           │
     │                                       │                           │
```

### 4.2 密鑰管理流程

```
┌──────────────────────────────────────────────────────────────────┐
│                      密鑰管理架構                                 │
└──────────────────────────────────────────────────────────────────┘

Admin User                        Proxy Container
    │                                    │
    │  1. 提交真實 API Key               │
    │  POST /admin/keys                  │
    │  {provider: "openai", key: "sk-xxx"}│
    │───────────────────────────────────►│
    │                                    │
    │                    2. 加密存儲 Key │
    │                       生成 Key ID  │
    │                                    │
    │  3. 返回 Key ID                    │
    │  {key_id: "key_abc123"}            │
    │◄───────────────────────────────────│
    │                                    │
    │  4. 為主容器生成代理 Key           │
    │  POST /admin/proxy-keys            │
    │  {key_id: "key_abc123", agent_id: "agent_1"}│
    │───────────────────────────────────►│
    │                                    │
    │                    5. 生成代理 Key │
    │                       proxy_key = "proxy_xyz789"
    │                       存儲映射關係 │
    │                                    │
    │  6. 返回代理 Key (注入主容器)      │
    │  {proxy_key: "proxy_xyz789"}       │
    │◄───────────────────────────────────│
```

---

## 5. 實作計畫表

### 5.1 階段一：基礎架構搭建 (Phase 1 - Foundation)

**預計時間**: 2-3 週

| 編號 | 任務 | 優先級 | 狀態 | 負責模組 | 預計工時 |
|------|------|--------|------|----------|----------|
| P1-01 | 設計 Docker Compose 配置文件 | 🔴 高 | ⬜ 待開始 | Infrastructure | 4h |
| P1-02 | 建立主容器 Dockerfile | 🔴 高 | ⬜ 待開始 | Main Container | 4h |
| P1-03 | 建立副容器 Dockerfile | 🔴 高 | ⬜ 待開始 | Proxy Container | 4h |
| P1-04 | 實作容器間內部網路配置 | 🔴 高 | ⬜ 待開始 | Infrastructure | 3h |
| P1-05 | 設計環境變量管理系統 | 🟡 中 | ⬜ 待開始 | Config | 3h |
| P1-06 | 建立 Docker Volume 持久化方案 | 🟡 中 | ⬜ 待開始 | Infrastructure | 2h |
| P1-07 | 實作健康檢查端點 | 🟡 中 | ⬜ 待開始 | Both | 2h |

### 5.2 階段二：代理服務開發 (Phase 2 - Proxy Server)

**預計時間**: 3-4 週

| 編號 | 任務 | 優先級 | 狀態 | 負責模組 | 預計工時 |
|------|------|--------|------|----------|----------|
| P2-01 | 設計 Proxy API Server 架構 | 🔴 高 | ⬜ 待開始 | Proxy Server | 6h |
| P2-02 | 實作代理 Key 生成演算法 | 🔴 高 | ⬜ 待開始 | Key Manager | 4h |
| P2-03 | 實作 Key 映射與存儲邏輯 | 🔴 高 | ⬜ 待開始 | Key Manager | 6h |
| P2-04 | 實作 OpenAI API 轉發邏輯 | 🔴 高 | ⬜ 待開始 | Proxy Server | 8h |
| P2-05 | 實作請求/響應日誌記錄 | 🟡 中 | ⬜ 待開始 | Audit Logger | 4h |
| P2-06 | 實作 Token 用量統計 | 🟡 中 | ⬜ 待開始 | Audit Logger | 4h |
| P2-07 | 實作 Rate Limiter | 🟡 中 | ⬜ 待開始 | Rate Limiter | 4h |
| P2-08 | 設計 Admin API 介面 | 🟡 中 | ⬜ 待開始 | Admin API | 4h |

### 5.3 階段三：主容器整合 (Phase 3 - Main Container Integration)

**預計時間**: 2-3 週

| 編號 | 任務 | 優先級 | 狀態 | 負責模組 | 預計工時 |
|------|------|--------|------|----------|----------|
| P3-01 | 開發 API Client 模組 (支援代理) | 🔴 高 | ⬜ 待開始 | API Client | 6h |
| P3-02 | 整合現有 Agent Engine | 🔴 高 | ⬜ 待開始 | Agent Core | 6h |
| P3-03 | 移除真實 Key 依賴 | 🔴 高 | ⬜ 待開始 | Security | 2h |
| P3-04 | 實作錯誤處理與重試邏輯 | 🟡 中 | ⬜ 待開始 | Error Handler | 4h |
| P3-05 | 實作代理故障降級策略 | 🟡 中 | ⬜ 待開始 | Fallback | 4h |
| P3-06 | 整合測試 | 🟡 中 | ⬜ 待開始 | Testing | 6h |

### 5.4 階段四：安全加固 (Phase 4 - Security Hardening)

**預計時間**: 2 週

| 編號 | 任務 | 優先級 | 狀態 | 負責模組 | 預計工時 |
|------|------|--------|------|----------|----------|
| P4-01 | 實作 mTLS 加密通訊 | 🔴 高 | ⬜ 待開始 | Security | 6h |
| P4-02 | 實作 API Key 加密存儲 | 🔴 高 | ⬜ 待開始 | Key Manager | 4h |
| P4-03 | 實作請求簽名驗證 | 🟡 中 | ⬜ 待開始 | Security | 4h |
| P4-04 | 安全審計與滲透測試 | 🟡 中 | ⬜ 待開始 | Security | 8h |
| P4-05 | 實作密鑰自動輪換 | 🟢 低 | ⬜ 待開始 | Key Manager | 4h |

### 5.5 階段五：多供應商擴展 (Phase 5 - Multi-Provider Support)

**預計時間**: 2-3 週

| 編號 | 任務 | 優先級 | 狀態 | 負責模組 | 預計工時 |
|------|------|--------|------|----------|----------|
| P5-01 | 支援 Anthropic Claude API | 🟡 中 | ⬜ 待開始 | Proxy Server | 6h |
| P5-02 | 支援 Google Gemini API | 🟡 中 | ⬜ 待開始 | Proxy Server | 6h |
| P5-03 | 支援 Azure OpenAI API | 🟢 低 | ⬜ 待開始 | Proxy Server | 4h |
| P5-04 | 設計統一 API 抽象層 | 🟡 中 | ⬜ 待開始 | API Client | 6h |
| P5-05 | 實作供應商路由邏輯 | 🟢 低 | ⬜ 待開始 | Router | 4h |

### 5.6 階段六：監控與運維 (Phase 6 - Monitoring & Operations)

**預計時間**: 2 週

| 編號 | 任務 | 優先級 | 狀態 | 負責模組 | 預計工時 |
|------|------|--------|------|----------|----------|
| P6-01 | 整合 Prometheus 監控 | 🟡 中 | ⬜ 待開始 | Monitoring | 4h |
| P6-02 | 建立 Grafana 儀表板 | 🟡 中 | ⬜ 待開始 | Monitoring | 4h |
| P6-03 | 實作 Alert 警報機制 | 🟡 中 | ⬜ 待開始 | Monitoring | 4h |
| P6-04 | 建立日誌聚合系統 | 🟡 中 | ⬜ 待開始 | Logging | 4h |
| P6-05 | 撰寫運維文檔 | 🟢 低 | ⬜ 待開始 | Documentation | 4h |

---

## 6. 安全性設計

### 6.1 威脅模型分析

| 威脅類型 | 風險等級 | 防護措施 |
|----------|----------|----------|
| API Key 洩漏 | 🔴 高 | 副容器隔離存儲、加密保護 |
| 中間人攻擊 | 🟡 中 | mTLS 加密通訊 |
| 容器逃逸 | 🟡 中 | Docker 安全配置、最小權限 |
| DDoS 攻擊 | 🟡 中 | Rate Limiter、請求限制 |
| 內部威脅 | 🟢 低 | 審計日誌、最小權限 |

### 6.2 安全配置清單

```yaml
# docker-compose.yml 安全配置示例 (草案)
services:
  main-container:
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL
    environment:
      - API_KEY=${PROXY_KEY}  # 只注入代理 Key

  proxy-container:
    security_opt:
      - no-new-privileges:true
    secrets:
      - openai_api_key
      - encryption_key
    volumes:
      - proxy-data:/data:rw  # 加密存儲
```

### 6.3 密鑰生命週期管理

```
┌─────────────────────────────────────────────────────────┐
│                  密鑰生命週期                            │
└─────────────────────────────────────────────────────────┘

  生成 → 分發 → 使用 → 輪換 → 撤銷 → 銷毀
   │      │      │      │      │      │
   ▼      ▼      ▼      ▼      ▼      ▼
 管理員  注入容器 代理轉發 定期更換 立即失效 安全清除
 提交     主容器          (30天)        
```

---

## 7. 風險評估

### 7.1 技術風險

| 風險項目 | 影響程度 | 發生概率 | 應對策略 |
|----------|----------|----------|----------|
| 副容器單點故障 | 高 | 中 | 實現高可用集群 |
| 代理層性能瓶頸 | 中 | 中 | 緩存、負載均衡 |
| 容器間網路延遲 | 低 | 高 | 優化網路配置 |
| API 相容性問題 | 中 | 低 | 版本管理、測試 |

### 7.2 運維風險

| 風險項目 | 影響程度 | 發生概率 | 應對策略 |
|----------|----------|----------|----------|
| 配置錯誤 | 高 | 中 | 配置驗證、變更審核 |
| 密鑰丟失 | 高 | 低 | 備份機制、多地存儲 |
| 監控盲區 | 中 | 中 | 完善監控體系 |

---

## 8. 未來擴展

### 8.1 短期目標 (3 個月內)

- [ ] 完成基礎雙容器架構
- [ ] 支援 OpenAI API 代理
- [ ] 實現基本審計功能
- [ ] 完成安全加固

### 8.2 中期目標 (6 個月內)

- [ ] 支援多 AI 供應商
- [ ] 實現高可用部署
- [ ] 完善監控告警
- [ ] 建立 Web 管理介面

### 8.3 長期目標 (12 個月內)

- [ ] 支援多主容器水平擴展
- [ ] 實現智能負載均衡
- [ ] 建立 Kubernetes 部署方案
- [ ] 開源社區建設

---

## 📌 附錄

### A. 參考資料

- [Docker Security Best Practices](https://docs.docker.com/engine/security/)
- [OpenAI API Documentation](https://platform.openai.com/docs)
- [mTLS Implementation Guide](https://www.cloudflare.com/learning/access-management/what-is-mutual-tls/)

### B. 變更歷史

| 版本 | 日期 | 變更內容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-21 | 初始版本 | MartletMolt Team |

---

> **下一步**: 確認架構設計後，開始 Phase 1 - 基礎架構搭建